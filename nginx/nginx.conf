# Nginx config configured with the help of antonputra
# https://github.com/antonputra/tutorials/blob/224/lessons/224/nginx/nginx.conf

# Defines user and group credentials used by worker processes
user nginx;

# Define the backend service.
worker_processes auto;
worker_cpu_affinity auto;

# change the default thread pool settings
thread_pool default threads=4 max_queue=50000;

# Limit on the maximum number of open file (RLIMIT_NOFILE) for worker processes
worker_rlimit_nofile 300000;

# Logging configuration
error_log /var/log/nginx/error.log notice;

# Defines a file that will store the process ID of the main process.
# pid /var/run/nginx.pid;

events {
    # Maximum number of simultaneous connections that can be opened by a worker process.
    worker_connections 50000;

    # serve many clients each thread (linux only)
    # used because nginx will be running on docker only
    use epoll;

    # Accept as many connections as possible. If it is disabled, a worker process
    # will accept one new connection at a time.
    multi_accept on;
}

http {
    # copies data between one FD and other from within the kernel
    # faster than read() + write()
    sendfile on;

    # use the default thread pool for asynchronous file I/O
    aio threads;

    # Only use AIO is used for when larger than or equal to this size
    directio 6m;

    # Send headers in one piece, it is better than sending them one by one
    tcp_nopush on;
    tcp_nodelay on;

    # disable logging if a file cannot be found
    log_not_found on;

    # Server will close connection after  this time
    keepalive_timeout 60s;

    # maxsize of types hash tables
    # (processing static sets of data. eg. server names,
    # map directives of mime types)
    types_hash_max_size 2048;

    # Max allowed size of the client request body
    client_max_body_size 64M;

    # If the request body size is more than the buffer size, then the entire (or partial)
    # request body is written into a temporary file
    client_body_buffer_size 512K;

    # Request timed out
    client_body_timeout 300s;

    # Allow the server to close connection on non responding client
    # this will free up memory
    reset_timedout_connection on;

    # Include Mime (Multipurpose Internet Mail Extension) types.
    include /etc/nginx/mime.types;

    # Define the default MIME type of a response
    default_type application/octet-stream;

    # Configures logging.
    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
    '\$status \$body_bytes_sent "\$http_referer" '
    '"\$http_user_agent" "\$http_x_forwarded_for"';

    # Enabled compression using "gzip" method.
    gzip on;

    # Disables gzipping for requests with "User-Agent" header fields
    # matching any of the specified regular expressions.
    gzip_disable msie6;

    # Enables inserting the "vary: Accept-Encoding" response header field.
    gzip_vary on;

    # Sets a gzip compression level of a response.
    # Acceptable values are in the range of 1 to 9.
    gzip_comp_level 3;

    # Sets the minimum length of a response that will be gzipped.
    gzip_min_length 256;

    # Sets the number and size of buffers used to compress response.
    gzip_buffers 16 8k;

    # Enables compression for all proxied requests.
    gzip_proxied any;

    # Enabled gzipping of responses for the specified
    # MIME types in addition to "text/html".
    gzip_types
    text/css
    text/plain
    text/javascript
    text/cache-manifest
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy
    application/javascript
    application/json
    application/x-javascript
    application/ld+json
    application/xml
    application/xml+rss
    application/x-font-ttf
    application/x-font-opentype
    application/vnd.ms-fontobject
    application/manifest+json
    application/rss+xml
    application/atom_xml
    application/vnd.geo+json
    application/x-web-app-manifest+json
    application/wasm
    image/svg+xml
    image/x-icon
    image/bmp
    font/opentype;

    include /etc/nginx/conf.d/*.conf;
}
